<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tech.petfriends.mypage.dao.MypageDao">

    <select id="getPetsByMemberCode" resultType="com.tech.petfriends.mypage.dto.MyPetDto">
		SELECT *
		FROM MEMBER_PET P
		JOIN MEMBER M ON P.MEM_CODE = M.MEM_CODE
		WHERE M.MEM_CODE=#{param1}
	</select>
	
	<update id="removeMainPet">
		UPDATE MEMBER_PET
		SET PET_MAIN='N'
		WHERE PET_CODE=#{param1}
	</update>
	
	<update id="setMainPet">
		UPDATE MEMBER_PET
		SET PET_MAIN='Y'
		WHERE PET_CODE=#{param1}
	</update>
	
	<select id="getInfoByPetCode" resultType="com.tech.petfriends.mypage.dto.MyPetDto">
		SELECT *
		FROM MEMBER_PET
		WHERE PET_CODE=#{param1}
	</select>
	
	<select id="getAllCoupon" resultType="com.tech.petfriends.admin.dto.CouponDto">
		SELECT *
		FROM COUPON
		WHERE (SYSDATE BETWEEN CP_START AND CP_END) AND (CP_KEYWORD IS NULL)
	</select>
	
	<select id="getCouponByMemberCode" resultType="com.tech.petfriends.admin.dto.CouponDto">
		SELECT CP.CP_NO,CP_NAME,CP_KEYWORD,CP_START,CP_END,CP_DEAD,CP_TYPE,CP_AMOUNT
		FROM COUPON CP
		JOIN MEMBER_COUPON_BRIDGE MC ON CP.CP_NO=MC.CP_NO
		WHERE MEM_CODE=#{param1} AND MC_USE IS NULL AND MC_DEAD IS NULL
	</select>
	
	<select id="searchCouponByKeyword" resultType="com.tech.petfriends.admin.dto.CouponDto">
		SELECT *
		FROM COUPON
		WHERE CP_KEYWORD=#{param1}
	</select>
	
	<select id="checkIssued" resultType="int">
		SELECT COUNT(*)
		FROM MEMBER_COUPON_BRIDGE
		WHERE MEM_CODE=#{param1} AND CP_NO=#{param2}
	</select>
	
	<insert id="insertCouponByCouponNo">
		INSERT INTO MEMBER_COUPON_BRIDGE
		VALUES(#{param1},#{param2},#{param3},SYSDATE,NULL,NULL)
	</insert>
	
	<select id="getAddrByMemberCode" resultType="com.tech.petfriends.login.dto.MemberAddressDto">
		SELECT *
		FROM ADDRESS
		WHERE MEM_CODE=#{param1}
	</select>
	
	<update id="updatePhoneNumber">
	    UPDATE MEMBER
	    SET MEM_TELL = #{phoneNumber}
	    WHERE MEM_CODE = #{memCode}
	</update>
	
	<update id="updateDefaultAddress">
	    UPDATE ADDRESS
	    SET ADDR_DEFAULT = 'N'
	    WHERE MEM_CODE = #{memCode} AND ADDR_DEFAULT = 'Y'
	</update>
	
	<update id="setMainAddress">
    	UPDATE ADDRESS
    	SET ADDR_DEFAULT = 'Y'
    	WHERE ADDR_CODE = #{addrCode}
	</update>
	
	<delete id="deleteAddress">
	    DELETE
	    FROM ADDRESS
	    WHERE ADDR_CODE = #{addrCode}
	</delete>
	
	<insert id="insertNewAddress">
	    INSERT INTO ADDRESS (ADDR_CODE, MEM_CODE, ADDR_POSTAL, ADDR_LINE1, ADDR_LINE2, ADDR_DEFAULT)
	    VALUES (#{addrCode}, #{memCode}, #{addrPostal}, #{addrLine1}, #{addrLine2}, 'Y')
	</insert>
	
	<update id="updateMemberInfo">
    	UPDATE MEMBER
		SET MEM_EMAIL = #{mem_email},
		    MEM_NAME = #{mem_name},
		    MEM_NICK = #{mem_nick},
		    MEM_BIRTH = #{mem_birth}
		WHERE MEM_CODE = #{mem_code}
	</update>
</mapper>
