<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tech.petfriends.mypage.dao.MypageDao">
	
	<insert id="insertMyPet" parameterType="com.tech.petfriends.mypage.dto.MyPetDto">
		INSERT INTO MEMBER_PET (PET_CODE, MEM_CODE, PET_TYPE, PET_NAME, PET_IMG, PET_BREED,
		PET_BIRTH, PET_GENDER, PET_WEIGHT, PET_NEUT, PET_FORM, PET_CARE, PET_ALLERGY, PET_MAIN)
		VALUES (#{pet_code}, #{mem_code}, #{pet_type}, #{pet_name}, #{pet_img}, #{pet_breed}, #{pet_birth}, #{pet_gender},
		#{pet_weight}, #{pet_neut}, #{pet_form}, #{pet_care}, #{pet_allergy}, #{pet_main})
	</insert>

    <select id="getPetsByMemberCode" resultType="com.tech.petfriends.mypage.dto.MyPetDto">
		SELECT *
		FROM MEMBER_PET P
		JOIN MEMBER M ON P.MEM_CODE = M.MEM_CODE
		WHERE M.MEM_CODE=#{param1}
	</select>
	
	<update id="removeMainPet">
		UPDATE MEMBER_PET
		SET PET_MAIN='N'
		WHERE PET_MAIN='Y' AND MEM_CODE=#{param1}
	</update>
	
	<update id="setMainPet">
		UPDATE MEMBER_PET
		SET PET_MAIN='Y'
		WHERE PET_CODE=#{param1}
	</update>
	
	<select id="getBreedOptionByType" resultType="String">
		SELECT PB_OPTION
		FROM PET_BREED
		WHERE PB_TYPE=#{petType}
	</select>
	
	<insert id="insertPet" parameterType="com.tech.petfriends.mypage.dto.MyPetDto">
	    INSERT INTO MEMBER_PET
	    VALUES (
	        #{pet_code}, #{mem_code}, #{pet_type}, #{pet_name}, #{pet_img}, #{pet_breed}, #{pet_birth}, 
	        #{pet_gender}, #{pet_weight}, #{pet_neut}, #{pet_form}, #{pet_care}, #{pet_allergy}, 'Y'
	    )
	</insert>
	
	<select id="getInfoByPetCode" resultType="com.tech.petfriends.mypage.dto.MyPetDto">
		SELECT *
		FROM MEMBER_PET
		WHERE PET_CODE=#{param1}
	</select>
	
	<update id="modifyPetByPetCode">
    	UPDATE MEMBER_PET
		SET PET_NAME = #{pet_name},
		    PET_IMG = #{pet_img},
		    PET_GENDER = #{pet_gender},
		    PET_WEIGHT = #{pet_weight},
		    PET_NEUT = #{pet_neut},
		    PET_FORM = #{pet_form},
		    PET_CARE = #{pet_care},
		    PET_ALLERGY = #{pet_allergy}
		WHERE PET_CODE=#{pet_code}
	</update>
	
	<delete id="deletePetByPetCode">
	    DELETE
	    FROM MEMBER_PET
	    WHERE PET_CODE=#{petCode}
	</delete>
	
	<select id="getAllCoupon" resultType="com.tech.petfriends.admin.dto.CouponDto">
		SELECT *
		FROM COUPON
		WHERE (SYSDATE BETWEEN CP_START AND CP_END) AND (CP_KEYWORD IS NULL)
	</select>
	
	<select id="getCouponByMemberCode" resultType="com.tech.petfriends.admin.dto.CouponDto">
		SELECT CP.CP_NO,CP_NAME,CP_KEYWORD,CP_START,CP_END,CP_DEAD,CP_TYPE,CP_AMOUNT
		FROM COUPON CP
		JOIN MEMBER_COUPON_BRIDGE MC ON CP.CP_NO=MC.CP_NO
		WHERE MEM_CODE=#{param1} AND MC_USE IS NULL AND MC_DEAD IS NULL
	</select>
	
	<select id="searchCouponByKeyword" resultType="com.tech.petfriends.admin.dto.CouponDto">
		SELECT *
		FROM COUPON
		WHERE CP_KEYWORD=#{param1}
	</select>
	
	<select id="checkIssued" resultType="int">
		SELECT COUNT(*)
		FROM MEMBER_COUPON_BRIDGE
		WHERE MEM_CODE=#{param1} AND CP_NO=#{param2}
	</select>
	
	<insert id="insertCouponByCouponNo">
		INSERT INTO MEMBER_COUPON_BRIDGE
		VALUES(#{param1},#{param2},#{param3},SYSDATE,NULL,NULL)
	</insert>
	
	<select id="getAddrByMemberCode" resultType="com.tech.petfriends.login.dto.MemberAddressDto">
		SELECT *
		FROM ADDRESS
		WHERE MEM_CODE=#{param1}
	</select>
	
	<update id="updatePhoneNumber">
	    UPDATE MEMBER
	    SET MEM_TELL = #{phoneNumber}
	    WHERE MEM_CODE = #{memCode}
	</update>
	
	<update id="updateDefaultAddress">
	    UPDATE ADDRESS
	    SET ADDR_DEFAULT = 'N'
	    WHERE MEM_CODE = #{memCode} AND ADDR_DEFAULT = 'Y'
	</update>
	
	<update id="setMainAddress">
    	UPDATE ADDRESS
    	SET ADDR_DEFAULT = 'Y'
    	WHERE ADDR_CODE = #{addrCode}
	</update>
	
	<delete id="deleteAddress">
	    DELETE
	    FROM ADDRESS
	    WHERE ADDR_CODE = #{addrCode}
	</delete>
	
	<insert id="insertNewAddress">
	    INSERT INTO ADDRESS (ADDR_CODE, MEM_CODE, ADDR_POSTAL, ADDR_LINE1, ADDR_LINE2, ADDR_DEFAULT)
	    VALUES (#{addrCode}, #{memCode}, #{addrPostal}, #{addrLine1}, #{addrLine2}, 'Y')
	</insert>
	
	<update id="updateMemberInfo">
    	UPDATE MEMBER
		SET MEM_EMAIL = #{mem_email},
		    MEM_NAME = #{mem_name},
		    MEM_NICK = #{mem_nick},
		    MEM_BIRTH = #{mem_birth}
		WHERE MEM_CODE = #{mem_code}
	</update>
	
	<select id="getCartByMemberCode" resultType="com.tech.petfriends.mypage.dto.MyCartDto">
		SELECT PI.MAIN_IMG1,
		       P.PRO_NAME,
		       PO.PROOPT_NAME,
		       PO.PROOPT_PRICE,
		       P.PRO_DISCOUNT,
		       PO.PROOPT_FINALPRICE,
		       MC.CART_CNT,
		       PO.PROOPT_STOCK,
		       MC.CART_CODE
		FROM PRODUCT_CART MC
		LEFT JOIN PRODUCT_IMAGE PI ON MC.PRO_CODE = PI.PRO_CODE
		LEFT JOIN PRODUCT P ON MC.PRO_CODE = P.PRO_CODE
		LEFT JOIN PRODUCT_OPTION PO ON MC.PROOPT_CODE = PO.PROOPT_CODE
		WHERE MC.MEM_CODE = #{mem_code} AND P.PRO_ONOFF = '판매'
		GROUP BY MC.CART_REGDATE, PI.MAIN_IMG1, P.PRO_NAME, PO.PROOPT_NAME, PO.PROOPT_PRICE, P.PRO_DISCOUNT, PO.PROOPT_FINALPRICE, MC.CART_CNT, PO.PROOPT_STOCK, MC.CART_CODE
		ORDER BY MC.CART_REGDATE
	</select>
	
	<delete id="deleteAllCartItems">
		DELETE FROM PRODUCT_CART
		WHERE MEM_CODE = #{mem_code}
	</delete>
	
	<update id="updateCartQuantity">
    	UPDATE PRODUCT_CART
		SET CART_CNT = #{newQuantity}
		WHERE CART_CODE = #{cartCode}
	</update>
	
	<select id="getItemByCartCode" resultType="com.tech.petfriends.mypage.dto.MyCartDto">
		SELECT PI.MAIN_IMG1,
		       P.PRO_NAME,
		       PO.PROOPT_NAME,
		       PO.PROOPT_PRICE,
		       P.PRO_DISCOUNT,
		       PO.PROOPT_FINALPRICE,
		       MC.CART_CNT,
		       PO.PROOPT_STOCK,
		       MC.CART_CODE
		FROM PRODUCT_CART MC
		LEFT JOIN PRODUCT_IMAGE PI ON MC.PRO_CODE = PI.PRO_CODE
		LEFT JOIN PRODUCT P ON MC.PRO_CODE = P.PRO_CODE
		LEFT JOIN PRODUCT_OPTION PO ON MC.PROOPT_CODE = PO.PROOPT_CODE
		WHERE MC.CART_CODE = #{cartCode}
		GROUP BY MC.CART_REGDATE, PI.MAIN_IMG1, P.PRO_NAME, PO.PROOPT_NAME, PO.PROOPT_PRICE, P.PRO_DISCOUNT, PO.PROOPT_FINALPRICE, MC.CART_CNT, PO.PROOPT_STOCK, MC.CART_CODE
	</select>
	
	<delete id="deleteCartItem">
		DELETE FROM PRODUCT_CART
		WHERE CART_CODE = #{cartCode}
	</delete>
	
	<select id="getItemsByCartCodes" resultType="com.tech.petfriends.mypage.dto.MyCartDto">
	    SELECT PI.MAIN_IMG1,
	           P.PRO_NAME,
	           PO.PROOPT_NAME,
	           PO.PROOPT_PRICE,
	           P.PRO_DISCOUNT,
	           PO.PROOPT_FINALPRICE,
	           MC.CART_CNT,
	           PO.PROOPT_STOCK,
	           MC.CART_CODE
	    FROM PRODUCT_CART MC
	    LEFT JOIN PRODUCT_IMAGE PI ON MC.PRO_CODE = PI.PRO_CODE
	    LEFT JOIN PRODUCT P ON MC.PRO_CODE = P.PRO_CODE
	    LEFT JOIN PRODUCT_OPTION PO ON MC.PROOPT_CODE = PO.PROOPT_CODE
	    WHERE MC.CART_CODE IN
	    <foreach item="cartCode" collection="cartCodes" open="(" separator="," close=")">
	        #{cartCode}
	    </foreach>
	    GROUP BY MC.CART_REGDATE, PI.MAIN_IMG1, P.PRO_NAME, PO.PROOPT_NAME, PO.PROOPT_PRICE, P.PRO_DISCOUNT, PO.PROOPT_FINALPRICE, MC.CART_CNT, PO.PROOPT_STOCK, MC.CART_CODE
	</select>
	
	<select id="getAllWishInfoByMemberCode" resultType="com.tech.petfriends.mypage.dto.MyWishDto">
		SELECT P.PRO_CODE,
			   P.PRO_NAME,
		       MIN(PO.PROOPT_FINALPRICE) AS MIN_PRICE,
		       COALESCE(AVG(PR.REVIEW_RATING), 0) AS REVIEW_AVG,
		       COUNT(PR.REVIEW_CODE) AS REVIEW_COUNT,
		       PI.MAIN_IMG1
		FROM MEMBER_WISHLIST W
		JOIN PRODUCT P ON W.PRO_CODE = P.PRO_CODE
		LEFT JOIN PRODUCT_OPTION PO ON P.PRO_CODE = PO.PRO_CODE
		LEFT JOIN PRODUCT_IMAGE PI ON P.PRO_CODE = PI.PRO_CODE
		LEFT JOIN PRODUCT_REVIEW PR ON P.PRO_CODE = PR.PRO_CODE
		WHERE W.MEM_CODE = #{mem_code}
		GROUP BY P.PRO_CODE, P.PRO_NAME, PI.MAIN_IMG1, W.WISHDATE
		<choose>
			<when test="sortType == '최근 추가순'">ORDER BY W.WISHDATE DESC</when>
			<when test="sortType == '낮은가격순'">ORDER BY MIN_PRICE ASC</when>
			<when test="sortType == '높은가격순'">ORDER BY MIN_PRICE DESC</when>
			<when test="sortType == '리뷰 많은순'">ORDER BY REVIEW_COUNT DESC</when>
			<when test="sortType == '리뷰 높은순'">ORDER BY REVIEW_AVG DESC</when>
		</choose>
	</select>
	
	<delete id="deleteWishByProCode">
	    DELETE
	    FROM MEMBER_WISHLIST
	    WHERE MEM_CODE = #{mem_code} AND PRO_CODE = #{pro_code}
	</delete>
</mapper>
