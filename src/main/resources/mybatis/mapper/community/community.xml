<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 게시글 목록 가져오기 -->
<mapper namespace="com.tech.petfriends.community.mapper.IDao">
	
	<select id="getPostList"
		resultType="com.tech.petfriends.community.dto.CDto">
		SELECT CD.*, RCI.*, COALESCE(MP.PET_IMG, 'noPetImg.jpg') AS PET_IMG
		FROM COMMUNITY_BOARD CD
		JOIN RE_CBOARD_IMAGE RCI ON CD.BOARD_NO = RCI.BOARD_NO
		LEFT JOIN MEMBER_PET MP ON CD.MEM_CODE = MP.MEM_CODE AND MP.PET_MAIN = 'Y'
		ORDER BY CD.BOARD_NO DESC
	</select>

	
	<select id="getPetIMG"
		resultType="com.tech.petfriends.community.dto.CDto">
		SELECT PET_IMG 
		FROM MEMBER_PET
		WHERE MEM_CODE = #{mem_code} 
		AND PET_MAIN = 'Y' 		
	</select> 
	


	<insert id="write">
		INSERT INTO COMMUNITY_BOARD (BOARD_NO,
		B_CATE_NO, MEM_CODE, USER_ID,
		BOARD_TITLE, BOARD_PASSWORD, BOARD_CONTENT, BOARD_CREATED, BOARD_MODIFIED,
		BOARD_VIEWS,BOARD_TAG, BOARD_LIKES, BOARD_COMMENT_COUNT)
		VALUES
		(COMMUNITY_BOARD_SEQ.NEXTVAL, #{b_cate_no},#{mem_code}, #{mem_nick}, #{board_title},
		1234, #{board_content},SYSDATE, null, 0, 'tag1', 0, 0)
	</insert>

	<select id="selBid" resultType="_int">
		SELECT MAX(BOARD_NO) FROM
		COMMUNITY_BOARD
	</select>

	<insert id="imgWrite">
		INSERT INTO RE_CBOARD_IMAGE(REBNO, BOARD_NO,
		CORGFILE, CCHGFILE, OREPFILE, CHREPFILE) VALUES
		(RE_CBOARD_IMAGE_SEQ.NEXTVAL,
		#{board_no}, #{originalFile},
		#{changeFile}, #{repImgOriginal}, #{repImgChange})
	</insert>

	<select id="contentView"
		resultType="com.tech.petfriends.community.dto.CDto">		
		SELECT CD.*, RCI.*, COALESCE(MP.PET_IMG, 'noPetImg.jpg') AS PET_IMG 
		FROM COMMUNITY_BOARD CD
		LEFT JOIN RE_CBOARD_IMAGE RCI ON CD.BOARD_NO = RCI.BOARD_NO
		LEFT JOIN MEMBER_PET MP ON CD.MEM_CODE = MP.MEM_CODE AND MP.PET_MAIN = 'Y'
		WHERE CD.BOARD_NO = #{board_no}
	</select>


	<select id="selectImg"
		resultType="com.tech.petfriends.community.dto.CDto">
		SELECT * FROM RE_CBOARD_IMAGE WHERE BOARD_NO = #{board_no}
	</select>

	<select id="getCategoryList"
		resultType="com.tech.petfriends.community.dto.CCategoryDto">
		SELECT B_CATE_NO, B_CATE_NAME FROM BOARD_CATEGORY
	</select>

	<select id="getPostsByCategory" parameterType="int"
		resultType="com.tech.petfriends.community.dto.CDto">
		SELECT * FROM COMMUNITY_BOARD
		<if test="b_cate_no != 0">
			WHERE B_CATE_NO = #{b_cate_no} ORDER BY BOARD_NO DESC
		</if>
	</select>

	<select id="getAllPosts"
		resultType="com.tech.petfriends.community.dto.CDto">
		SELECT * FROM COMMUNITY_BOARD
	</select>


	<update id="modify">
		UPDATE COMMUNITY_BOARD
		SET BOARD_TITLE = #{param2},
		BOARD_CONTENT = #{param3},
		BOARD_MODIFIED = CURRENT_TIMESTAMP,
		B_CATE_NO = #{param4}
		WHERE BOARD_NO = #{param1}
	</update>

	<update id="modifyImg">
		UPDATE RE_CBOARD_IMAGE
		SET CORGFILE = #{originalFile},
		CCHGFILE = #{changeFile},
		OREPFILE = #{repImgOriginal},
		CHREPFILE = #{repImgChange}
		WHERE BOARD_NO = #{board_no}
	</update>

	
	
	<delete id="delete">
		DELETE FROM COMMUNITY_BOARD WHERE BOARD_NO = #{board_no}
	</delete>


	<insert id="comment">
		INSERT INTO COMMUNITY_COMMENT (COMMENT_NO, BOARD_NO, USER_ID,
		COMMENT_CONTENT, CREATED_DATE, PARENT_COMMENT_NO, COMMENT_LEVEL,
		COMMENT_ORDER_NO, EDITED_DATE, MEM_CODE)
		VALUES (COMMUNITY_COMMENT_SEQ.NEXTVAL, #{board_no}, #{mem_nick},
		#{comment_content}, SYSDATE, COMMUNITY_COMMENT_SEQ.CURRVAL,0,0, SYSDATE, #{mem_code})
	</insert>

	<select id="commentList"
		resultType="com.tech.petfriends.community.dto.CCommentDto">
		SELECT DISTINCT CC.*, MP.PET_IMG
		FROM COMMUNITY_COMMENT CC
		JOIN MEMBER_PET MP ON CC.MEM_CODE = MP.MEM_CODE
		WHERE CC.COMMENT_LEVEL = 0 
		AND CC.BOARD_NO = #{board_no}
		AND MP.PET_MAIN = 'Y'
		ORDER BY CC.COMMENT_NO
	</select>

	<insert id="commentReply">
		INSERT INTO COMMUNITY_COMMENT (COMMENT_NO, BOARD_NO, USER_ID,
		COMMENT_CONTENT, CREATED_DATE, PARENT_COMMENT_NO, COMMENT_LEVEL,
		COMMENT_ORDER_NO, EDITED_DATE, MEM_CODE)
		VALUES (COMMUNITY_COMMENT_SEQ.NEXTVAL, #{board_no}, #{mem_nick},
		#{comment_content}, SYSDATE, #{parent_comment_no}, #{comment_level} + 1,
		#{comment_order_no} + 1, SYSDATE, #{mem_code})
	</insert>

	<select id="commentReplyList"
		resultType="com.tech.petfriends.community.dto.CCommentDto">
		SELECT CC.*, MP.PET_IMG
		FROM COMMUNITY_COMMENT CC
		JOIN MEMBER_PET MP ON CC.MEM_CODE = MP.MEM_CODE
		WHERE CC.COMMENT_LEVEL >= 1 
		AND CC.BOARD_NO = #{board_no}
		AND MP.PET_MAIN = 'Y'
		ORDER BY CC.COMMENT_LEVEL
	</select>

	<update id="commentShape">
		UPDATE COMMUNITY_COMMENT
		SET
		comment_level=comment_level + 1
		WHERE PARENT_COMMENT_NO=#{param1} AND
		COMMENT_LEVEL > #{param2}
	</update>


	<delete id="replyDelete">
		DELETE FROM COMMUNITY_COMMENT
		WHERE (SELECT
		COUNT(COMMENT_NO) FROM COMMUNITY_COMMENT
		WHERE PARENT_COMMENT_NO=#{parent_comment_no}
		AND COMMENT_LEVEL = #{comment_level}+1
		AND COMMENT_ORDER_NO > #{comment_order_no})=0
		AND COMMENT_NO=#{comment_no}
	</delete>


	<update id="stepInit">
		UPDATE COMMUNITY_COMMENT SET
		COMMENT_LEVEL=COMMENT_LEVEL-1
		WHERE PARENT_COMMENT_NO = #{parent_comment_no}
		AND COMMENT_LEVEL> #{comment_level}
	</update>

	<insert id="addLike">
		INSERT INTO COMMUNITY_LIKES 
		(LIKE_ID, BOARD_NO, USER_ID, CREATED_DATE, MEM_CODE) 
		VALUES (COMMUNITY_LIKES_SEQ.NEXTVAL, #{board_no}, #{mem_nick}, SYSDATE, #{mem_code})
	</insert>

	<delete id="removeLike">
		DELETE FROM COMMUNITY_LIKES 
		WHERE board_no = #{board_no} AND MEM_CODE = #{mem_code}
	</delete>

	<select id="isLiked" resultType="int">
		SELECT COUNT(*) FROM COMMUNITY_LIKES 
		WHERE BOARD_NO = #{board_no} AND MEM_CODE = #{mem_code}
	</select>


	<select id="getLikesCount" resultType="int">
		SELECT COUNT(*) FROM COMMUNITY_LIKES 
		WHERE BOARD_NO = #{board_no} 
	</select>

	<select id="getHotTopicList" resultType="com.tech.petfriends.community.dto.CDto">
	SELECT CB.BOARD_NO, CB.BOARD_TITLE ,
	        (CB.BOARD_LIKES + CB.BOARD_COMMENT_COUNT) AS TOTAL_COUNT, 
	       RCI.CHREPFILE
	FROM COMMUNITY_BOARD CB
	LEFT JOIN RE_CBOARD_IMAGE RCI ON CB.BOARD_NO = RCI.BOARD_NO
	ORDER BY TOTAL_COUNT DESC
	</select>
	
	<insert id="addFeed">
	INSERT INTO COMMUNITY_FEED (FEED_NO, MEM_CODE, BOARD_NO, USER_ID)
	VALUES (COMMUNITY_FEED_SEQ.NEXTVAL, #{mem_code}, #{board_no}, #{mem_nick})
	</insert>


	<select id="myFeedList"
	resultType="com.tech.petfriends.community.dto.CDto">
	SELECT CD.*, RCI.*, COALESCE(MP.PET_IMG, 'noPetImg.jpg') AS PET_IMG, CF.*, CF.USER_ID
	FROM COMMUNITY_BOARD CD
	LEFT JOIN RE_CBOARD_IMAGE RCI ON CD.BOARD_NO = RCI.BOARD_NO
	LEFT JOIN MEMBER_PET MP ON CD.MEM_CODE = MP.MEM_CODE AND MP.PET_MAIN = 'Y'
	LEFT JOIN COMMUNITY_FEED CF ON CD.BOARD_NO = CF.BOARD_NO
	WHERE CD.MEM_CODE = #{mem_code}
	ORDER BY CD.BOARD_NO DESC
	</select>

	<select id="myFeedName"
	resultType="com.tech.petfriends.community.dto.CDto">
	SELECT MEM_NICK
	FROM MEMBER 
	WHERE MEM_CODE = #{mem_code}
	</select>

	<insert id="report">
		INSERT INTO COMMUNITY_REPORT (REPORT_ID, BOARD_NO, REPORTER_ID,
		REASON, REPORT_DATE, STATUS, COMMENT_NO, REPORT_TYPE)
		VALUES
		(COMMUNITY_REPORT_SEQ.NEXTVAL, #{board_no}, #{reporter_id}, 
		#{reason}, SYSDATE, DEFAULT, #{comment_no}, #{report_type})
	</insert>

	<update id="incrementViews"  parameterType="String" >
        UPDATE COMMUNITY_BOARD SET BOARD_VIEWS = BOARD_VIEWS + 1 
        WHERE BOARD_NO = #{board_no}
    </update>
	
	<insert id="addFriend">
		INSERT INTO COMMUNITY_FRIEND (MEM_NICK, FRIEND_MEM_NICK, FRIEND_CREATED)
		VALUES(#{mem_nick}, #{friend_mem_nick}, SYSDATE)
	
	</insert>
	
	<select id="isFriend" resultType="int">
		SELECT COUNT(*) 
		FROM COMMUNITY_FRIEND 
		WHERE MEM_NICK = #{mem_nick} AND FRIEND_MEM_NICK = #{friend_mem_nick}
	</select>
	
	
	<delete id="deleteFriend">
		DELETE FROM COMMUMITY_FRIEND WHERE MEM_NICK = #{mem_nick}
	</delete>

<select id="getNeighborList" resultType="com.tech.petfriends.community.dto.CCommunityFriendDto">
        SELECT 
            FRIEND_MEM_NICK
        FROM 
            COMMUNITY_FRIEND 
        WHERE 
            MEM_NICK = #{mem_nick}

	</select>
</mapper>